# ---------------------------------
# Docker Compose with default ports (can be overridden by .env)
# ---------------------------------

services:
  atomspace-api:
    image: deazstar/custom-query-builder:custom-atomspace-api
    container_name: atomspace-api
    ports:
      - "${ATOMSPACE_API_PORT:-8001}:${API_PORT:-8001}"
    environment:
      - HUGEGRAPH_HOST=hugegraph-atomspace
      - HUGEGRAPH_PORT=8080
      - HUGEGRAPH_GRAPH=hugegraph
      - ANNOTATION_SERVICE_URL=http://annotation_service:${ANNOTATION_SERVICE_PORT:-5800}/annotation/load
      - API_PORT=${API_PORT:-8001}
    volumes:
      - ./custom-atomspace-builder/output:/app/output
      - atomspace_logs:/app/logs
      - shared_output:/shared/output
    depends_on:
      hugegraph:
        condition: service_started
    networks:
      - atomspace-network
    restart: always

  hugegraph:
    image: hugegraph/hugegraph:1.5.0
    container_name: hugegraph-atomspace
    ports:
      - "${HUGEGRAPH_PORT_EXTERNAL:-8080}:8080"
      - "8182:8182"
    environment:
      - HUGEGRAPH_CONF=/hugegraph/conf
    volumes:
      - hugegraph_data:/hugegraph/data
      - hugegraph_logs:/hugegraph/logs
    networks:
      - atomspace-network
    restart: unless-stopped

  annotation_service:
    image: deazstar/custom-query-builder:annotation-service-backend-general
    container_name: annotation_service
    ports:
      - "${ANNOTATION_SERVICE_PORT:-5800}:${APP_PORT:-5800}"
    command: python run.py
    restart: always
    depends_on:
      - mongodb
      - redis
    environment:
      - MONGO_URI=mongodb://mongodb:27017/annotation
      - APP_PORT=${APP_PORT:-5800}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379/0
      - REDIS_EXPIRATION=3600
      - MORK_URL=http://mork:8231
    networks:
      - atomspace-network
    volumes:
      - ./custom-atomspace-builder/output:/shared/output

  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongo_data:/data/db
    restart: always
    networks:
      - atomspace-network

  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    restart: always
    networks:
      - atomspace-network

  annotation-tool:
    image: deazstar/custom-query-builder:annotation-ui
    container_name: annotation-tool
    ports:
      - "${ANNOTATION_TOOL_PORT:-3000}:${ANNOTATION_TOOL_PORT:-3000}"
    environment:
      - LOADER_URL=http://127.0.0.1:${API_PORT:-8001}
      - ANNOTATION_URL=http://127.0.0.1:${APP_PORT:-5800}
    depends_on:
      - atomspace-api
      - annotation_service
    network_mode: host
    restart: always

  mork:
    image: deazstar/custom-query-builder:mork-pathmap
    container_name: mork_pathmap
    ports:
      - "8231:8231"
    volumes:
      - ./MORK:/app # local code bind mount
      - ./custom-atomspace-builder/output:/shared/output # shared volume
    networks:
      - atomspace-network
    restart: always

volumes:
  hugegraph_data:
  hugegraph_logs:
  atomspace_logs:
  shared_output:
  mongo_data:
  redis_data:

networks:
  atomspace-network:
    driver: bridge
